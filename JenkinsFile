import groovy.json.JsonSlurper
import java.nio.file.Paths
import hudson.model.*

pipeline{

agent any

options{
    buildDiscarder(logRotator(numToKeepStr:'20'))
}

// triggers{cron(getCronPattern())}

parameters{
    choice name:'Env_Name',
    choices:['test','dev','stage','prod'],
    description:'Select The Environment'

    choice name:'Browser_Name',
    choices:['chrome','MicrosoftEdge','firefox'],
    description:'Select Browser'
}

stages{
    stage('Build')
    {
        steps{
            script{
                try{
                    sh """
                    echo 'Entered Into Build Phase'
                    npm install
                    npm run selenium-standalone-install
                    echo 'Build Success'
                    """
                    currentBuild.result = 'SUCCESS'
                }
                catch(Exception e)
                {
                    echo '**************** Build Error ************'
                    isBuildStatusFail=true
                    currentBuild.result='FAILURE'
                }
            }
        }
    }
    stage('Test')
        {
        steps{
            script{
                    try{
                        sh """
                        echo 'Entered Into Test Phase'
                        npm run selenium-standalone-start &
                        sleep 10s
                        npm run test --ENV=${Env_Name} --BROWSER=${Browser_Name}
                        npm run clean-port
                        echo 'Test Success'
                        """
                        currentBuild.result = 'SUCCESS'
                    }
                    catch(Exception e)
                    {
                        echo '**************** Test Error ************'+e
                        isBuildStatusFail=true
                        currentBuild.result='FAILURE'
                    }
                }
            }
        }
        stage('Report')
        {
            steps{
                cucumber '**/reports/json/*.json'
                def build = manager.build

                int total = build.getTestResultAction().getTotalCount()
                int failed = build.getTestResultAction().getFailCount()
                int skipped = build.getTestResultAction().getSkipCount()
                // can also be accessed like build.testResultAction.failCount
                manager.listener.logger.println('Total: ' + total)
                manager.listener.logger.println('Failed: ' + failed)
                manager.listener.logger.println('Skipped: ' + skipped)
                manager.listener.logger.println('Passed: ' + (total - failed - skipped))
                emailext mimeType : 'text/html',
                body:"""Automation Test Result ${env.JOB_NAME} is ${currentBuild.result}.
                <br></br>
                <br>The Build status is ${currentBuild.result}.
                <br>Build URL:${BUILD_URL}cucumber-html-reports/overview-features.html.
                <br> Pass % is ${total - failed - skipped}% ."""
                subject: "Automation Test Result for build no ${env.BUILD_NUMBER} "
                to:"${env.emailAddress}"
                attachmentsPattern:'reports/html/*.html'
            }
        }
    }

    post{
        always{
            echo 'This will always run'
        }
        success{
            echo 'This will run only if successful'
        }
        failure{
            echo 'This will run only if failed'
        }
        unstable{
            echo 'This will run only if the run was marked as unstable'
        }
        changed{
            echo 'This will run only if the status of the pipeline has changed'
            echo 'For example, if the pipeline was perviously failing but is now successful'
        }
    }
}

    def getCronPattern()
    {
        if(env.BRANCH_NAME=='master')
        {
            return '* * * * *'
        }
    }
